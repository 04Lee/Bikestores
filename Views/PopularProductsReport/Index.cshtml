@model IEnumerable<Bikestores.Controllers.PopularProductsReportController.PopularProduct>

@{
    ViewBag.Title = "Popular Products Report";
    string fromDate = ViewBag.FromDate as string ?? "";
    string toDate = ViewBag.ToDate as string ?? "";
    string selectedBrand = ViewBag.SelectedBrand as string ?? "";
    string selectedCategory = ViewBag.SelectedCategory as string ?? "";
    var brands = ViewBag.Brands as List<string> ?? new List<string>();
    var categories = ViewBag.Categories as List<string> ?? new List<string>();
}

<h2 class="text-center my-4 text-primary">Popular Products Report</h2>

<form id="filterForm" method="get" class="mb-4 d-flex flex-wrap justify-content-center gap-3 align-items-end">
    <div class="form-group">
        <label for="fromDate" class="form-label">From</label>
        <input id="fromDate" type="date" name="from" value="@fromDate" class="form-control" />
    </div>

    <div class="form-group">
        <label for="toDate" class="form-label">To</label>
        <input id="toDate" type="date" name="to" value="@toDate" class="form-control" />
    </div>

    <div class="form-group">
        <label for="brandFilter" class="form-label">Brand</label>
        <select id="brandFilter" name="brand" class="form-control">
            <option value="">All</option>
            @foreach (var brand in brands)
            {
                <option value="@brand" @(brand == selectedBrand ? "selected" : "")>@brand</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="categoryFilter" class="form-label">Category</label>
        <select id="categoryFilter" name="category" class="form-control">
            <option value="">All</option>
            @foreach (var category in categories)
            {
                <option value="@category" @(category == selectedCategory ? "selected" : "")>@category</option>
            }
        </select>
    </div>

    <button type="submit" class="btn btn-primary mb-0">Filter</button>
    <button type="button" id="btnClearFilters" class="btn btn-secondary mb-0">Clear Filters</button>
</form>

@if (!Model.Any())
{
    <div class="text-center text-muted">No orders found in the selected period.</div>
}
else
{
    <div class="text-center mb-2 text-muted">
        Chart: Top 50 Products | Table: Top 10 Products
    </div>

    <div style="max-width: 800px; margin: auto;">
        <canvas id="popularProductsChart" height="350"></canvas>
    </div>

    <div class="overflow-auto mt-3" style="max-width: 600px; margin: auto;">
        <table class="table table-striped table-bordered rounded shadow-sm mb-0" style="font-size: 0.85rem;">
            <thead class="table-primary text-uppercase text-center fw-bold" style="font-size: 0.8rem;">
                <tr>
                    <th>Product</th>
                    <th>Brand</th>
                    <th>Category</th>
                    <th>Times Ordered</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.OrderByDescending(p => p.TimesOrdered).Take(10))
                {
                    <tr class="align-middle text-center" style="font-size: 0.85rem;">
                        <td>@item.ProductName</td>
                        <td>@item.BrandName</td>
                        <td>@item.CategoryName</td>
                        <td>@item.TimesOrdered</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-wrap justify-content-center gap-3 mt-4">
        <button id="btnOpen" class="btn btn-info text-white px-4 shadow">Open PDF</button>
        <button id="btnPrint" class="btn btn-warning text-white px-4 shadow">Print PDF</button>
        <button id="btnDownload" class="btn btn-success text-white px-4 shadow">Download PDF</button>
        <form class="d-flex" onsubmit="return saveReport(event);">
            <input type="text" id="fileName" class="form-control me-2" placeholder="Filename" required style="width: 180px;" />
            <button id="btnSave" type="submit" class="btn btn-outline-primary">Save to Archive</button>
        </form>
    </div>
}

@Html.Action("Archive", new { from = fromDate, to = toDate, brand = selectedBrand, category = selectedCategory })

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    // Initialize Select2
    $('#brandFilter').select2({ placeholder: "Select Brand", allowClear: true });
    $('#categoryFilter').select2({ placeholder: "Select Category", allowClear: true });

    $('#brandFilter').on('change', function() {
        $('#categoryFilter').val(null).trigger('change');
    });

    $('#brandFilter, #categoryFilter').on('change', function() {
        $('#filterForm').submit();
    });

    $('#btnClearFilters').click(function() {
        $('#fromDate').val('');
        $('#toDate').val('');
        $('#brandFilter').val(null).trigger('change');
        $('#categoryFilter').val(null).trigger('change');
        $('#filterForm').submit();
    });

    // Chart uses Top 50 data
    var reportData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.OrderByDescending(p => p.TimesOrdered).Take(50)));
    var labels = reportData.map(p => p.ProductName);
    var dataPoints = reportData.map(p => p.TimesOrdered);

    function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const r = Math.floor(Math.random() * 156) + 100;
            const g = Math.floor(Math.random() * 156) + 100;
            const b = Math.floor(Math.random() * 156) + 100;
            colors.push(`rgba(${r}, ${g}, ${b}, 0.85)`);
        }
        return colors;
    }

    var backgroundColors = generateColors(reportData.length);

    var ctx = document.getElementById('popularProductsChart').getContext('2d');
    var popularChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Times Ordered',
                data: dataPoints,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(c => c.replace('0.85', '1')),
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { size: 11 } } },
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });

    function getPdfDocDef() {
        return {
            content: [
                { text: 'Popular Products Report', style: 'header' },
                { image: popularChart.toBase64Image(), width: 600, height: 350, margin: [0, 12, 0, 25] },
                {
                    table: {
                        headerRows: 1,
                        widths: ['*', '*', '*', 100],
                        body: [
                            ['Product', 'Brand', 'Category', 'Times Ordered'],
                            ...reportData.map(r => [r.ProductName, r.BrandName, r.CategoryName, r.TimesOrdered])
                        ]
                    },
                    layout: { fillColor: rowIndex => rowIndex % 2 === 0 ? '#f5f7fa' : null }
                }
            ],
            styles: { header: { fontSize: 22, bold: true, alignment: 'center', margin: [0,0,0,15] } }
        };
    }

    $('#btnOpen').click(() => pdfMake.createPdf(getPdfDocDef()).open());
    $('#btnPrint').click(() => pdfMake.createPdf(getPdfDocDef()).print());
    $('#btnDownload').click(() => pdfMake.createPdf(getPdfDocDef()).download('PopularProductsReport.pdf'));

    function saveReport(e) {
        e.preventDefault();
        var filename = $('#fileName').val().trim();
        const btn = $('#btnSave');
        if (!filename) return;

        btn.prop('disabled', true).text('Saving...');

        pdfMake.createPdf(getPdfDocDef()).getBase64(base64 => {
            fetch('@Url.Action("SaveReport")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileName: filename, base64Pdf: base64 })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) location.reload();
            })
            .catch(err => alert('Error saving report: ' + err.message))
            .finally(() => btn.prop('disabled', false).text('Save to Archive'));
        });
    }
    </script>
}
